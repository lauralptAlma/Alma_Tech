{% extends "almaFront/bases/blank.html" %}
{% load static %}
{% block tab-title %}Agenda{% endblock %}
{% block page-title %}Agenda{% endblock %}

{% block page-content %}
    <div class="form-row">
        <div class="form-group col-md-12 col-lg-12 col-xl-12">
            <form method="post" action="">
                <link rel="stylesheet"
                      href="{% static 'assets/fullcalendar-5.3.2/lib/main.css' %}">
                <div id='calendar'></div>
            </form>
            <form method="post" action="">
                {% csrf_token %}
                <div class="modal fade" id="exampleModal"
                     data-backdrop="static" tabindex="-1"
                     aria-labelledby="exampleModalLabel"
                     aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="exampleModalLabel">
                                    Datos de la Cita</h5>
                                {% if 'editarcita' not in request.path %}
                                    <button type="button" class="close"
                                            data-dismiss="modal"
                                            aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                {% endif %}
                            </div>
                            <div class="modal-body">
                                {{ form.non_field_errors }}
                                <div class="form-row">
                                    <div class="form-group col-md-8">
                                        <label>Paciente* :</label>
                                        {{ form.paciente }}
                                    </div>
                                    <div class="form-group col-md-8">
                                        <label>Profesional* :</label>
                                        {{ form.doctor }}
                                    </div>
                                    <div class="form-group col-md-8">
                                        <label>Fecha* :</label>
                                        {{ form.fecha }}
                                    </div>
                                    <div class="form-group col-md-4">
                                        <label>Hora* :</label>
                                        {{ form.hora }}
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="submit" id="btnAdd"
                                        class="btn btn-success">Agregar
                                </button>
                                <button id="btnEdit" class="btn btn-warning">
                                    Modificar
                                </button>
                                <input id="btnDelete" class="btn btn-danger"
                                       type="button" name="eliminar"
                                       value="Eliminar"/>
                                {% if 'editarcita' in request.path %}
                                    <input id="btnCancel"
                                           class="btn btn-secondary"
                                           type="submit" name="cancelar"
                                           value="Cancelar"/>
                                {% else %}
                                    <button id="btnCancel" data-dismiss="modal"
                                            class="btn btn-secondary">Cancelar
                                    </button>
                                {% endif %}
                            </div>
                            <!-- Modal confirm -->
                            <div class="modal" id="confirmModal" style="display: none; z-index: 1050;">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-body p-3 mb-2 bg-info text-white" id="confirmMessage">
                                        </div>
                                        <div class="modal-footer bg-light text-dark">
                                            <button type="submit" class="btn btn-danger" name="eliminar"  value="eliminar" id="confirmOk">Aceptar</button>
                                            <button type="button" class="btn btn-secondary" id="confirmCancel" data-dismiss="confirmModal">Cancelar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block page-javascript %}
    <script src="{% static 'assets/fullcalendar-5.3.2/lib/main.js' %}"></script>
    <script src="{% static 'assets/fullcalendar-5.3.2/lib/es.js' %}"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let calendarEl = document.getElementById('calendar');
            let calendar;
            calendar = new FullCalendar.Calendar(calendarEl, {
                timeZone: 'local',
                initialView: 'dayGridMonth',
                language: 'Spanish',
                selectable: true,
                nowIndicator: true,
                editable: true,
                headerToolbar: {
                    right: 'dayGridMonth, timeGridWeek, timeGridDay',
                    left: 'prev,next',
                    center: 'title'
                },
                businessHours: {
                    // days of week. an array of zero-based day of week integers (0=Sunday)
                    daysOfWeek: [1, 2, 3, 4, 5], // Monday - Friday
                    startTime: '09:00', // a start time (9am in this example)
                    endTime: '20:00', // an end time (7pm in this example)
                },
                slotLabelFormat: [
                    {
                        hour: 'numeric',
                        minute: '2-digit',
                        omitZeroMinute: false,
                        meridiem: 'short'
                    }
                ],

                events: [
                    {% for i in citasList %}
                        {
                            title: "{{ i.paciente.nombre }} {{ i.paciente.primer_apellido }}",
                            start: '{{ i.fecha|date:"Y-m-d" }}T{{ i.hora|time:"H:i"}}',
                            id: '{{ i.id }}',
                        },
                    {% endfor %}
                ],

                eventClick: function (info) {
                    location.href = `/dentalE/editarcita/${info.event.id}`;
                },

                dateClick: function (info) {
                    limpiarFormulario();
                    $('#id_fecha').val(info.dateStr);
                    $('#btnAdd').prop("disabled", false);
                    $('#btnEdit').prop("disabled", true);
                    $('#btnDelete').prop("disabled", true);
                    $('#exampleModal').modal('toggle');
                },

            });
            calendar.setOption('locale', 'es')
            calendar.render();

            function limpiarFormulario() {
                $('#id_paciente').val("");
                $('#txtProf').val("");
                $('#txtFecha').val("");
                $('#txtHora').val("");
            }


            var mensaje = "Est√° seguro que desea eliminar la cita?";
            $('#btnDelete').on('click', function (e) {
                confirmDialog(mensaje, function () {
                });
            });

            function confirmDialog(message, onConfirm) {
                var modal = $("#confirmModal");
                var fClose = function () {
                    modal.modal("hide");
                };
                modal.modal("show");
                $("#confirmMessage").empty().append(message);
                $("#confirmOk").unbind().one('click', onConfirm).one('click', fClose);
                $("#confirmCancel").unbind().one("click", fClose);
            }


        });
    </script>
    <script>
        $(document).ready(function () {
            if (location.href.includes('editarcita')) {
                $('#btnAdd').prop("disabled", true);
                $('#btnEdit').prop("disabled", false);
                $('#btnDelete').prop("disabled", false);
                $('#exampleModal').modal();
            }
        });
    </script>
{% endblock %}
